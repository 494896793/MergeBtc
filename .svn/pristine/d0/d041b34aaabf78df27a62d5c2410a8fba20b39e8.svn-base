package com.bochat.app.business.main.conversation;

import android.content.Intent;
import android.util.Log;

import com.bochat.app.business.RxErrorConsumer;
import com.bochat.app.business.RxErrorThrowable;
import com.bochat.app.common.contract.conversation.GroupManageForbiddenContract;
import com.bochat.app.common.model.IGroupModule;
import com.bochat.app.common.router.RouterGroupManage;
import com.bochat.app.common.router.RouterGroupManageEdit;
import com.bochat.app.common.router.RouterGroupManageForbidden;
import com.bochat.app.model.bean.CodeEntity;
import com.bochat.app.model.bean.DynamicIncomeOfTodayEntity;
import com.bochat.app.model.bean.DynamicQueryUserBXInfoEntity;
import com.bochat.app.model.bean.FriendEntity;
import com.bochat.app.model.bean.GroupEntity;
import com.bochat.app.model.bean.GroupForbiddenListEntity;
import com.bochat.app.model.bean.GroupMemberEntity;
import com.bochat.app.model.bean.InviteCodeEntity;
import com.bochat.app.model.greendao.DBManager;
import com.bochat.app.model.util.LogUtil;
import com.bochat.app.mvp.presenter.BasePresenter;

import java.util.List;

import javax.inject.Inject;

import io.reactivex.Observable;
import io.reactivex.ObservableEmitter;
import io.reactivex.ObservableOnSubscribe;
import io.reactivex.android.schedulers.AndroidSchedulers;
import io.reactivex.disposables.Disposable;
import io.reactivex.functions.Consumer;
import io.reactivex.schedulers.Schedulers;

/**
 * Author      : FJ
 * CreateDate  : 2019/04/26 10:52
 * Description :
 */

public class GroupManageForbiddenPresenter extends BasePresenter<GroupManageForbiddenContract.View> implements GroupManageForbiddenContract.Presenter {
    private  GroupEntity groupEntity;
    private int prohibitState;
    private int mPosition;
    private GroupMemberEntity groupMemberEntity;
    private  List<GroupMemberEntity> list;
    private int mCurrenPage;
    private int mTotalPage;
    private boolean isFirst;
    @Inject
    IGroupModule groupModule;
    @Override
    public void initInjector() {
        getBusinessComponent().inject(this);
    }

    @Override
    public void onViewRefresh() {
        super.onViewRefresh();
        if (list != null){
            list.clear();
        }
        RouterGroupManageForbidden extra = getExtra(RouterGroupManageForbidden.class);
        if (extra.getGroupEntity() != null) {
            groupEntity = extra.getGroupEntity();

            //获取对应群的群成员
        list=DBManager.getInstance().findGroupMembersByGroupId(Long.valueOf(groupEntity.getGroup_id()));
//            LogUtil.LogDebug("ggyy","mmoo=="+list.toString());
//            LogUtil.LogDebug("GroupManageForbiddenPresenter","mmoo=="+list.get(0));

        }
        if (!isFirst){
            getGruopForbiddenMemberList(1);
            isFirst = true;
        }

    }

    @Override
    public void onChangeGlobalForbiddenSwitch(boolean isGlobalForbidden) {

        //todo 修改保存groupid 判读

        if (isGlobalForbidden){
            prohibitState = 2;
        }else {
            prohibitState = 1;
        }
        Disposable subscribe = Observable.create(new ObservableOnSubscribe<CodeEntity>() {
            @Override
            public void subscribe(ObservableEmitter<CodeEntity> emitter) throws Exception {
                try {
                    CodeEntity entity = groupModule.muteAllMembers(String.valueOf(groupEntity.getGroup_id()),String.valueOf(prohibitState));
                    if(entity.getRetcode() != 0){
                        CodeEntity codeEntity = new CodeEntity();
                        codeEntity.setCode(entity.getCode());
                        codeEntity.setMsg(entity.getMsg());
                        codeEntity.setRetcode(entity.getRetcode());
                        emitter.onError(new RxErrorThrowable(codeEntity));
                        return;
                    }

                    emitter.onNext(entity);
                    emitter.onComplete();
                } catch (Exception e) {
                    emitter.onError(e);
                    e.printStackTrace();
                }
            }
        }).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()).subscribe(new Consumer<CodeEntity>() {
            @Override
            public void accept(CodeEntity entity) throws Exception {
                getView().hideLoading("");
                if (entity.getCode() == 0 ){
                    if (prohibitState == 1){
                        getView().changeGlobalForbidden(false);
                    }else if(prohibitState == 2){
                        getView().changeGlobalForbidden(true);
                    }

                }
            }
        }, new RxErrorConsumer<Throwable>(this)  {
            @Override
            public void acceptError(Throwable object) {
                getView().hideLoading("");
            }
        });
        getView().showLoading(subscribe);
    }

    @Override
    public void getGruopForbiddenMemberList(final int currenPage) {
        mCurrenPage = currenPage;
        if (currenPage != 1 && currenPage > mTotalPage){
            getView().showTips("没有更多数据了");
            getView().cancleLoadmore();
            return;
        }

        Disposable subscribe = Observable.create(new ObservableOnSubscribe<GroupForbiddenListEntity>() {
            @Override
            public void subscribe(ObservableEmitter<GroupForbiddenListEntity> emitter) throws Exception {
                try {
                    GroupForbiddenListEntity entity = groupModule.queryMuteMembers(String.valueOf(currenPage),"2",String.valueOf(groupEntity.getGroup_id()));
                    if(entity.getRetcode() != 0){
                        CodeEntity codeEntity = new CodeEntity();
                        codeEntity.setCode(entity.getCode());
                        codeEntity.setMsg(entity.getMsg());
                        codeEntity.setRetcode(entity.getRetcode());
                        emitter.onError(new RxErrorThrowable(codeEntity));
                        return;
                    }

                    emitter.onNext(entity);
                    emitter.onComplete();
                } catch (Exception e) {
                    emitter.onError(e);
                    e.printStackTrace();
                }
            }
        }).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()).subscribe(new Consumer<GroupForbiddenListEntity>() {
            @Override
            public void accept(GroupForbiddenListEntity entity) throws Exception {
                getView().hideLoading("");

                getView().onUpdateList(entity.getItems());
                getView().cancleLoadmore();
                getView().cancleRefash();
                mTotalPage = entity.getTotalPage();
            }
        }, new RxErrorConsumer<Throwable>(this)  {
            @Override
            public void acceptError(Throwable object) {
                getView().hideLoading("");
                getView().cancleLoadmore();
                getView().cancleRefash();
            }
        });
        getView().showLoading(subscribe);

    }

    @Override
    public void onRelieveForbiddenClick(int position) {
        mPosition = position;
        LogUtil.LogDebug("ggyy"+position + "== "+mPosition);
        groupMemberEntity = list.get(position);

        //todo 网络请求解除禁言  最好对应的是同一数组 不能删除数据库的数据

        Disposable subscribe = Observable.create(new ObservableOnSubscribe<CodeEntity>() {
            @Override
            public void subscribe(ObservableEmitter<CodeEntity> emitter) throws Exception {
                try {
                    LogUtil.LogDebug("GroupManageForbiddenPresenter","getMemberId ="+groupMemberEntity.getMember_id());

                    CodeEntity entity = groupModule.muteMembers(String.valueOf(groupMemberEntity.getGroup_id()),String.valueOf(groupMemberEntity.getMember_id()),"1");
                    if(entity.getRetcode() != 0){
                        CodeEntity codeEntity = new CodeEntity();
                        codeEntity.setCode(entity.getCode());
                        codeEntity.setMsg(entity.getMsg());
                        codeEntity.setRetcode(entity.getRetcode());
                        emitter.onError(new RxErrorThrowable(codeEntity));
                        return;
                    }

                    emitter.onNext(entity);
                    emitter.onComplete();
                } catch (Exception e) {
                    emitter.onError(e);
                    e.printStackTrace();
                }
            }
        }).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()).subscribe(new Consumer<CodeEntity>() {
            @Override
            public void accept(CodeEntity entity) throws Exception {
                getView().hideLoading("");
                //todo 更新button
                getView().updateRelieveBtton(mPosition);


            }
        }, new RxErrorConsumer<Throwable>(this)  {
            @Override
            public void acceptError(Throwable object) {
                getView().hideLoading("");
            }
        });
        getView().showLoading(subscribe);
    }
}

package com.bochat.app.app.adapter;

import android.content.Context;
import android.graphics.Color;
import android.graphics.drawable.Drawable;
import android.support.annotation.NonNull;
import android.support.v7.widget.RecyclerView;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ImageView;
import android.widget.RelativeLayout;
import android.widget.TextView;

import com.bochat.app.R;
import com.bochat.app.model.bean.DynamicFlashEntity;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * create by guoying ${Date} and ${Month}
 */
public class DynamicFlashAdapter extends RecyclerView.Adapter<DynamicFlashAdapter.FlashViewHolder> {
    int thumbs[] = {R.mipmap.empty_icon,R.mipmap.empty_icon_sel,R.mipmap.favorable_icon,R.mipmap.favorable_icon_sel};
    private Context mContext;
    private List<DynamicFlashEntity> mData;
    private onRiseAndDeclineClick mListener;
    Map<Integer,Boolean> checkRiseMap;
    Map<Integer,Boolean> checkDeclineMap;

    public DynamicFlashAdapter(Context mContext, List<DynamicFlashEntity> mData) {
        this.mContext = mContext;
        this.mData = mData;
        initData();

    }

    public void refreshData(List<DynamicFlashEntity> list){
        mData.clear();
        mData = list;
        mData.addAll(list);
        initData();

        notifyDataSetChanged();
    }

    public void loadData(List<DynamicFlashEntity> list){
        mData = list;
        int position = mData.size();
        mapSize = position;
        mData.addAll(position,list);
        initData();
        notifyDataSetChanged();
    }

    @NonNull
    @Override
    public FlashViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
        View view = LayoutInflater.from(mContext).inflate(R.layout.item_dynamic_flash,parent,false);
        FlashViewHolder flashViewHolder = new FlashViewHolder(view);
        return flashViewHolder;
    }

    @Override
    public void onBindViewHolder(@NonNull final FlashViewHolder holder, final int position) {
        final DynamicFlashEntity entity = mData.get(position);
        final int riseNum = entity.getAdmire();
        final int delinceNum = entity.getTrample();

        if (riseIsCheck(position)){
            holder.riseImg.setImageResource(thumbs[3]);
            checkRiseMap.put(position,true);
        }else {
            holder.riseImg.setImageResource(thumbs[2]);
//            checkRiseMap.put(position,false);
        }
        if (declineIsCheck(position)){
            holder.declineImg.setImageResource(thumbs[1]);
            checkDeclineMap.put(position,true);
        }else {
            holder.declineImg.setImageResource(thumbs[0]);
//            checkDeclineMap.put(position,false);
        }


        if (entity.getIsHot().equals("1")){ //热点
            Drawable drawable= mContext.getResources().getDrawable(R.drawable.shape_circular_red_9);
            holder.spot.setBackground(drawable);

            holder.title.setTextColor(Color.parseColor("#F14348"));
            holder.content.setTextColor(Color.parseColor("#F14348"));
        }
//        LogUtil.LogDebug("ggyy","ggyy="+entity.getOption());

        if (entity.getOption() == null){
            entity.setOption("0");
        }
        if (entity.getOption().equals("1")){
            holder.riseImg.setImageResource(thumbs[3]);
            checkRiseMap.put(position,true);

        }
        if(entity.getOption().equals("2")){
            holder.declineImg.setImageResource(thumbs[1]);
            checkDeclineMap.put(position,true);

        }



        holder.date.setText(entity.getCreateTime());
        holder.title.setText(entity.getTitle());
        holder.content.setText(entity.getContent());
        holder.riseText.setText("利好"+entity.getAdmire()+"");
        holder.declineText.setText("利空"+entity.getTrample()+"");

        holder.riseText.setOnClickListener(new View.OnClickListener() {
           @Override
           public void onClick(View v) {
               holder.riseImg.setImageResource(thumbs[3]);
               holder.declineImg.setImageResource(thumbs[0]);
               mData.get(position).setOption("1");
//               LogUtil.LogDebug("ggyy","33333"+mData.get(position).getOption()+"");
               if (mListener!= null){
                   mListener.riseOnclick(entity.getId());
                   holder.riseText.setText("利好"+(riseNum+1));

                   mData.get(position).setAdmire(riseNum+1);
//                   LogUtil.LogDebug("ggyy","rise"+mData.get(position).getAdmire());
                   if (delinceNum < mData.get(position).getTrample()){
                       holder.declineText.setText("利空"+(mData.get(position).getTrample()-1));
                       mData.get(position).setTrample(mData.get(position).getTrample()-1);
//                       LogUtil.LogDebug("ggyy","de"+mData.get(position).getTrample());
                   }

               }

               setRiseDeclineClick(position,true,1);

           }
       });
       holder.declineText.setOnClickListener(new View.OnClickListener() {
           @Override
           public void onClick(View v) {
               holder.riseImg.setImageResource(thumbs[2]);
               holder.declineImg.setImageResource(thumbs[1]);
               mData.get(position).setOption("2");
               if (mListener != null){
                   mListener.declineClick(entity.getId());
                   holder.declineText.setText("利空"+(delinceNum+1));
                   mData.get(position).setTrample(delinceNum+1);
//                   LogUtil.LogDebug("ggyy","de"+mData.get(position).getTrample());
                   if (mData.get(position).getAdmire() > riseNum){
//                       LogUtil.LogDebug("ggyy","rise"+mData.get(position).getAdmire());
                       holder.riseText.setText("利好"+(mData.get(position).getAdmire()-1));
                       mData.get(position).setAdmire(mData.get(position).getAdmire()-1);
                   }
               }
               setRiseDeclineClick(position,true,2);
           }
       });

       holder.shareText.setOnClickListener(new View.OnClickListener() {
           @Override
           public void onClick(View v) {
               //todo 分享
               if (mListener != null){
                   mListener.shareOnClick(mData.get(position));
               }
           }
       });





    }

    @Override
    public int getItemCount() {
        return mData.size();
    }

    class FlashViewHolder extends RecyclerView.ViewHolder{
        ImageView spot;
        TextView date;
        TextView title;
        TextView content;
        ImageView riseImg;
        TextView riseText;
        ImageView declineImg;
        TextView declineText;
        TextView shareText;
        RelativeLayout relativeLayout;
        public FlashViewHolder(View itemView) {
            super(itemView);
            spot = itemView.findViewById(R.id.dynamic_flash_spot);
            date = itemView.findViewById(R.id.flash_date);
            title = itemView.findViewById(R.id.flash_title);
            content = itemView.findViewById(R.id.flash_content);
            riseImg = itemView.findViewById(R.id.flash_rise_img);
            riseText = itemView.findViewById(R.id.flash_rise_text);
            declineImg = itemView.findViewById(R.id.flash_decline_img);
            declineText = itemView.findViewById(R.id.flash_decline_text);
            shareText = itemView.findViewById(R.id.flash_share_text);
            relativeLayout = itemView.findViewById(R.id.flash_layout);
        }
    }

    int mapSize = 0;
    public void initData(){
        if (checkRiseMap == null){
            checkRiseMap = new HashMap<>();
        }
        if (checkDeclineMap == null){
            checkDeclineMap = new HashMap<>();
        }

        for (; mapSize <mData.size(); mapSize++){
            setRiseDeclineClick(mapSize,false,0);
        }
    }


    public void setRiseDeclineClick(int position, boolean isCheck ,int type){
        if (type == 0){
            checkRiseMap.put(position,isCheck);
            checkDeclineMap.put(position,isCheck);
        }

        if (type == 1){
            checkRiseMap.put(position,isCheck);
            checkDeclineMap.put(position,!isCheck);
        }
        if (type == 2){
            checkRiseMap.put(position,!isCheck);
            checkDeclineMap.put(position,isCheck);
        }

//        LogUtil.LogDebug("ggyy",type+"riseIsCheck="+checkRiseMap);
    }

    public boolean riseIsCheck(int positon){
//        LogUtil.LogDebug("ggyy","riseIsCheck="+checkRiseMap+mData.size());
        return  checkRiseMap.get(positon);
    }


    public boolean declineIsCheck(int positon){
        return checkDeclineMap.get(positon);
    }



    public void setOnRiseAndDeclineClickListener(onRiseAndDeclineClick listener){
        mListener = listener;
    }
    public interface onRiseAndDeclineClick{
        void riseOnclick(int flashId);
        void declineClick(int flashId);
        void shareOnClick(DynamicFlashEntity entity);
    }
}
